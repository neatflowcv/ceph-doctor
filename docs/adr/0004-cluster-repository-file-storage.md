# ADR 0004: Cluster Repository 파일 저장 전략

날짜: 2026-02-23
상태: 채택

## 배경

`cluster` 등록/조회/수정/삭제 기능을 구현하려면 저장소 계층이
필요하다. 동시에 아래 사항을 명확히 해야 한다.

- 도메인 계층이 저장 방식에 의존하지 않도록 인터페이스로 분리할 것.
- 로컬 실행 환경에서 표준 경로 정책(XDG)에 맞게 저장할 것.
- 파일 저장 시 부분 쓰기 손상을 줄이기 위한 원자적 쓰기 정책을 둘 것.
- 도메인 에러와 인프라 에러(I/O, 경로)를 혼합하지 않을 것.

## 결정

다음 정책을 채택한다.

1. `ClusterRepository` 인터페이스를 도메인 계층에 둔다.
2. 초기 구현은 파일 기반(`internal/infrastructure/fscluster`)으로 한다.
3. 저장 루트는 `XDG_STATE_HOME` 우선으로 한다.
   - 설정 시: `$XDG_STATE_HOME/ceph-doctor`
   - 미설정 시: `$HOME/.local/state/ceph-doctor`
4. 저장 레이아웃은 클러스터별 JSON 파일로 한다.
   - `<root>/clusters/<url.PathEscape(name)>.json`
5. 저장소 메서드는 아래 명칭을 사용한다.
   - `CreateCluster`, `UpdateCluster`, `ListClusters`, `DeleteCluster`
6. 파일 저장은 임시 파일 + `rename` 원자 교체를 사용한다.
7. 권한은 디렉토리 `0700`, 파일 `0600`으로 한다.
8. 도메인 에러는 비즈니스 의미가 있는 항목만 둔다.
   - `ErrClusterAlreadyExists`, `ErrClusterNotFound`
9. I/O/경로 오류는 도메인 에러로 치환하지 않고 원인 에러를 래핑한다.

## 대안

- 단일 파일(`clusters.json`) 저장:
  구현은 단순하나 일부 변경 시 전체 파일 재작성 부담이 크다.
- 고정 경로(`~/.config/ceph-doctor`) 사용:
  단순하지만 상태 데이터 저장 위치로 XDG 상태 경로가 더 적합하다.
- I/O 오류를 도메인 에러로 통합:
  계층 경계가 흐려지고 원인 진단이 어려워진다.
- 키링/암호화 즉시 도입:
  보안은 강화되나 초기 구현 복잡도와 운영 의존성이 크게 증가한다.

## 결과

- 도메인 계층은 저장 구현체 교체 가능성을 확보한다.
- 경로 정책이 표준화되어 운영 환경별 예측 가능성이 높아진다.
- 클러스터별 파일 저장으로 변경 단위가 작아지고 손상 영향 범위가 줄어든다.
- 현재 범위에서는 파일 락/동시성 제어, 암호화, 스키마 버전 관리는
  다루지 않으며 필요 시 별도 ADR로 확장한다.
